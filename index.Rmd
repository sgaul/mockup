---
title       : Mockup of top indicators
subtitle    : Hartford regional data and indicators
author      : 
job         : Community Indicators Project
framework   : io2012        # {io2012, html5slides, shower, dzslides, minimal ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      # 
ext_widgets : {rCharts: ["libraries/nvd3"]} 
mode        : selfcontained # {standalone, draft}

--- &twocol
## Outline of indicators

*** =left
Snapshot / demographics
* Population / diversity
* Commuting patterns
* School enrollment
* Income levels or poverty rates

Education
* 3rd grade reading
* High school graduation rate
* Chronic absenteeism

*** =right
Workforce / economy / talent
* Educational attainment
* Unemployment rate
* Labor force participation rate

Quality of life / community
* Home-ownership / housing cost
* Crime rates
* Voter turnout

---
## Who are we: Population and immigration

Source: [UConn State Data Center](http://ctsdc.uconn.edu/projections.html). Availability: 1900 - 2025 (2015 - 2025 projections). 

```{r setup, message = F, echo = F, cache = F}
require(rCharts)
knitr::opts_chunk$set(comment = NA, results = 'asis', tidy = F, message = T)
```
 
 
```{r chart1, echo=FALSE}
require(rCharts)
knitr::opts_chunk$set(comment = NA, results = 'asis', tidy = F, message = T)

gh <- read.csv("../regionalreport/data/greaterhartford.csv")
gh$poppoverty <- round((gh$poppovertyrate / 100) * gh$population,0)
gh_test <- ddply(merge(gh,towns,by.x = "city", by.y = "Town"),
                 .(period,Towngroup), summarise, 
                 sumpop = sum(population),
                 sumpoor = sum(poppoverty))

n1 <- nPlot(y = 'sumpop', x = 'period', width = 700, height = 425,
            group = 'Towngroup',
            data = subset(gh_test, period >= 1900),
            type = 'lineChart')
n1$xAxis(axisLabel='Year')
n1$yAxis(tickFormat = "#!function(d) {return d3.format(',.0f')(d)}!#", axisLabel='Population')
n1$chart(forceY = c(0,350000))
n1$print('chart1')
```

---
## Who are we: Population and immigration

Source: [UConn State Data Center](http://ctsdc.uconn.edu/projections.html). Availability: 1900 - 2025 (2015 - 2025 projections). 

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 12}
library(ggplot2)
library(reshape)
library(scales)
library(gridExtra)

ggplot(data = subset(merge(gh,towns,by.x = "city", by.y = "Town"),
                     Towngroup != "Hartford" & period >= 1950)) +
  geom_line(aes(x = period, y = population)) + 
  labs(x = "Year", y = "Population")
  scale_y_continuous(labels = comma) + 
  facet_wrap(~ city, scales = "free_y", ncol = 7) +
  theme_minimal()
```
---

## Who are we: Population and immigration

Source: [Refugee Processing Center](http://www.wrapsnet.org/). Availability: 2002 - present. 

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 12}
library(ggplot2)
library(reshape)
library(scales)
library(gridExtra)

refugees <- read.csv('Arrivals by Destination and Natoinality.csv')
refugees <- subset(refugees, refugees$textbox12City %in% levels(towns$Town))
refugees$textbox12City <- factor(refugees$textbox12City)

refugees$textbox14 <- gsub(pattern = "CY ",replacement = "",refugees$textbox14)

refugees$TownType = ifelse(refugees$textbox12City == "Hartford","Hartford","Suburbs")

refugees_agg <- ddply(refugees, .(TownType, textbox6, textbox14), summarise,
                      count = sum(textbox18))

ggplot(data = subset(refugees_agg, textbox6 %in% c('Bhutan',
                                                   'Bosnia and Herzegovina',
                                                   'Burma',
                                                   'Burundi',
                                                   'Cuba',
                                                   'Iraq',
                                                   'Liberia',
                                                   'Russia',
                                                   'Somalia',
                                                   'Sudan')), 
       aes(x = textbox14, y = count)) + 
  geom_line(aes(group = TownType, colour = TownType)) + 
  facet_wrap(~ textbox6, ncol = 2) + 
  theme_minimal() + 
  labs(x = 'Year', y = 'Number of arrivals')
```

--- 
## Who are we: languages in school

Source: [SDE](http://sdeportal.ct.gov/Cedar/WEB/ct_report/EllDT.aspx); availability: 2000-01 - 2010-11; breakouts: none.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 12}
languages <- read.csv('Languages-all.csv', na.strings = c("**","-"))

languages <- merge(languages, districts, by.x = "District.Name", by.y = "district")

languages_agg <- merge(ddply(languages, .(District.Name), summarise,all.lang = length(unique(Languages)),all.students = sum(Number.of.Students.with.Non.English.Home.Language, na.rm = TRUE)),
                       ddply(subset(languages, Number.of.ELL.Students > 0),
                             .(District.Name), summarise,ell.lang = length(unique(Languages)),ell.students = sum(Number.of.ELL.Students, na.rm = TRUE)),
                       by = "District.Name", 
                       all = TRUE)

#All linguistic diversity
languages_agg$District.Name <- reorder(languages_agg$District.Name,
                                       languages_agg$all.lang)

all1 <- ggplot(data = languages_agg) + 
  geom_point(aes(x = all.lang, y = District.Name)) + 
  labs(x = 'Number of languages spoken, all students', y = NULL) + 
  scale_x_continuous(labels = comma) + 
  theme_minimal()

#No. of ELL students
languages_agg$District.Name <- reorder(languages_agg$District.Name,
                                       languages_agg$ell.students) 
                                       
ell2 <- ggplot(data = subset(languages_agg, ell.students >= 0)) + 
  geom_point(aes(x = ell.students, y = District.Name)) + 
  labs(x = 'Number of ELL students', y = NULL) + 
  scale_x_continuous(labels = comma) + 
  theme_minimal()

grid.arrange(all1, ell2, ncol = 2, nrow = 1)
```

--- 
## Who are we: school enrollment

Source: [SDE](http://sdeportal.ct.gov/Cedar/WEB/ct_report/EnrollmentDT.aspx); availability: 2006-07 - 2010-11; breakouts: type of school

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 14}
enroll <- read.csv("../regionalreport/data/all-schools.csv", stringsAsFactors=FALSE)

#Filter out the towns that are not in the region and clear out the factors
enroll <- subset(enroll, enroll$Resident.Town %in% levels(towns$Town))
enroll$Resident.Town <- factor(enroll$Resident.Town)

charters <- data.frame(charters = c("The Bridge Academy District",
                            "Trailblazers Academy District",
                            "Side By Side Community School District",
                            "Park City Prep Charter School",
                            "Odyssey Community School District",
                            "New Beginnings Inc., Family Academy District",
                            "Jumoke Academy District",
                            "Highville Charter School District",  
                            "Highville Mustard Seed Charter School District",       
                            "Integrated Day Charter School District",        
                            "Interdistrict School for Arts and Comm District",
                            "Explorations District",
                            "Elm City College Preparatory School",
                            "Common Ground High School District",
                            "Charter School for Young Children on Asylum Hill",
                            "Bridgeport Achievement First",
                            "Achievement First Hartford Academy Inc.",                
                            "Amistad Academy District"))

#Make the charters into their own category
enroll$School.Type[enroll$Sent.to.District %in% levels(charters[,])] <- 'Public charter'

#Replace the less frequent school types with 'Other'
enroll$School.Type <- gsub("Homebound","Other",enroll$School.Type)
enroll$School.Type <- gsub("Voag","Other",enroll$School.Type)
enroll$School.Type <- gsub("Interdistrict Cooperative Agreement","Other",enroll$School.Type)
enroll$School.Type <- gsub("Designated High School","Other",enroll$School.Type)
enroll$School.Type <- gsub("Nonpublic","Private",enroll$School.Type)

#Melt the dataset to get it into a more normalized format for plotting
enroll <- melt(enroll, 
               measure.vars = c("PK","K","G1","G2","G3","G4","G5","G6","G7","G8","G9","G10","G11","G12","Total"),
               id.vars = c("Resident.Town.ID","District.ID","Resident.Town","Sent.to.District","School.Year","School.Type"))

#Get rid of the sent to districts since there are multiple districts for each
enroll <- aggregate(enroll$value,
                    list(Resident.Town = enroll$Resident.Town, 
                         School.Year = enroll$School.Year, 
                         School.Type = enroll$School.Type, 
                         variable = enroll$variable), 
                    sum)

#Sort the school types for the display
enroll$School.Type <- factor(enroll$School.Type, levels = c("Public",
                                                            "Private",
                                                            "Public charter",
                                                            "Magnet School",
                                                            "Open Choice","Other"))

ggplot(data = subset(enroll, School.Year == "2010-11" & variable != "Total"), 
       aes(x = variable, y = x, group = School.Type, fill = School.Type)) +
  geom_area(aes(order = as.numeric(School.Type)), position = "fill") +
  scale_y_continuous(labels = percent) +
  scale_x_discrete(breaks = c("K","G3","G6","G9","G12")) +
  labs(x = NULL, y = NULL) +
  scale_fill_brewer(palette = "Greys") +
  theme_minimal() +
  theme(strip.text.x = element_text(size = 12)) +
  facet_wrap(~ Resident.Town, ncol = 10)

#write.csv(enrollflow, "enrollflow.csv", row.names = FALSE)
#Next command: write.csv(subset(otm, ratio > 0.05 & !(Destination == "All Other Locations")), "commute.csv", row.names = FALSE)
```

--- 
## Who are we: commuting patterns

Source: [Census / DoL](http://onthemap.ces.census.gov/); availability: 2002 - 2011; breakouts: age, income, sector

![image](../mockup/commute-patterns.png)

--- 
## Who are we: poverty and income

Source: [Census](http://factfinder2.census.gov/); availability: most recent 2007-2011; breakouts: age, gender, race / ethnicity, commuting, others

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
library(gridExtra)
library(scales)

income$town <- reorder(income$town, -income$income)
inc1 <- ggplot(data = subset(income, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain")))) + 
  geom_point(aes(x = income, y = town)) + 
  geom_segment(aes(xend = income - se, x = income + se, y = town, yend = town), colour = "grey") + 
  labs(x = 'Median household income', y = NULL) + 
  scale_x_continuous(labels = comma) + 
  theme_minimal()

library(acs)
library(maps)
library(maptools)
key = "ba67d3a427e1f785987b9c8bc59341bf7c8a7cc1"
api.key.install(key)
#hartford.towns = geo.make(state = "CT", county = c("Hartford","Tolland"), county.subdivision = "*", check = T)
B17001 = acs.fetch(geography = hartford.towns, table.number = "B17001", col.names = "pretty")
poverty.estimate = divide.acs(numerator=B17001[,2],denominator=B17001[,1], method = 'proportion')
povertyacs = data.frame(town=geography(B17001)[[1]], 
                         rate=as.numeric(estimate(poverty.estimate)),
                         se=standard.error(poverty.estimate))
names(povertyacs) <- c("town","rate","se")
povertyacs$town= gsub(" town, Tolland County, Connecticut", "", povertyacs$town)
povertyacs$town= gsub(" town, Hartford County, Connecticut", "", povertyacs$town)
povertyacs$town <- reorder(povertyacs$town, povertyacs$rate)

inc2 <- ggplot(data = subset(povertyacs, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain")))) + 
  geom_point(aes(x = rate, y = town)) + 
  geom_segment(aes(xend = rate - se, x = rate + se, y = town, yend = town), colour = "grey") + 
  labs(x = '% living under federal poverty line (2007-2011 ACS estimates)', y = NULL) + 
  scale_x_continuous(labels = percent) + 
  theme_minimal()

grid.arrange(inc1,inc2,nrow=1)
```

--- 
## Who are we: poverty and income (2)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B19001&prodType=table); availability: most recent 2007-2011; breakouts: gender, race / ethnicity, others

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 11}
library(reshape)
library(ggplot2)
library(scales)
distn <- melt(read.csv('income-levels.csv'))

distn$Geography <- factor(distn$Geography, levels = c("Less than $25,000",
                                                      "$25,000 to $49,999",
                                                      "$50,000 to $74,999",
                                                      "$75,000 to $99,999",
                                                      "$100,000 to $124,999",
                                                      "$125,000 to $149,999",
                                                      "$150,000 to $199,999",
                                                      "$200,000 or more"))


ggplot(data = subset(distn, Stat == "Estimate" & Subgroup == "All" & variable !="CRCOG")) + 
  geom_line(aes(x = Geography, y = value, group = variable, colour = variable)) + 
  labs(x = "Household income", y = "Number of households") + 
  scale_y_continuous(labels = comma) +
  theme_minimal()
```

--- 
## Who are we: Regional poverty

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B19001&prodType=table); availability: 1970 - 2012

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 14}
ggplot(aes(y = sumpoor, x = period), data = subset(gh_sum,period >= 1970)) + 
  geom_line(aes(group = type, colour = type)) + 
  scale_y_continuous(labels = comma, limits = c(0,41000)) + 
  labs(x = "Year", y = 'Population', title = 'Population in poverty') +
  theme_minimal()
```

--- 
## Who are we: Regional poverty

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B19001&prodType=table); availability: 1970 - 2012

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 14}
ggplot(data = subset(acs1yr,Percent >= .3)) + 
  geom_point(aes(y = County.subdivision, x = Percent)) + 
  geom_segment(aes(xend = Percent - Percent.margin.of.error, 
                   x = Percent + Percent.margin.of.error, 
                   y = County.subdivision, yend = County.subdivision), colour = "grey") + 
  labs(x = '% living under poverty line (2012 estimates)', y = NULL, 
       title = 'Poverty rates') + 
  scale_x_continuous(labels = percent) + 
  theme_minimal()
```

--- 
## Who are we: poverty and income (3)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B19001&prodType=table); availability: most recent 2007-2011; breakouts: gender, race / ethnicity, others

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 11}
ggplot(data = subset(distn, Stat == "Percent" & Subgroup == "All" & variable !="CRCOG")) + 
  geom_line(aes(x = Geography, y = value, group = variable, colour = variable)) + 
  labs(x = "Household income", y = "Percent of households") + 
  scale_y_continuous(labels = percent) +
  theme_minimal()
```

--- 
## Who are we: poverty and income (4)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B19001&prodType=table); availability: most recent 2007-2011; breakouts: gender, race / ethnicity, others

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 11}
ggplot(data = subset(distn, Stat == "Estimate" & Subgroup != "All" & variable =="CRCOG")) + 
  geom_line(aes(x = Geography, y = value, group = Subgroup, colour = Subgroup)) + 
  labs(x = "Household income", y = "Number of households") + 
  scale_y_continuous(labels = comma) +
  theme_minimal()
```

--- 
## Who are we: poverty and income (5)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B19001&prodType=table); availability: most recent 2007-2011; breakouts: gender, race / ethnicity, others

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 11}
ggplot(data = subset(distn, Stat == "Percent" & Subgroup != "All" & variable =="CRCOG")) + 
  geom_line(aes(x = Geography, y = value, group = Subgroup, colour = Subgroup)) + 
  labs(x = "Household income", y = "Percent of households") + 
  scale_y_continuous(labels = percent) +
  theme_minimal()
```

--- 
## Who we are: income (by neighborhood)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B19001&prodType=table).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 7, fig.width = 11}
B19013 = acs.fetch(geography = hartford.tracts, table.number = "B19013", col.names = "pretty")

income.tract = data.frame(tract=geography(B19013)[,1],
                    income.estimate = estimate(B19013[,1]),
                    se=standard.error(B19013[,1]))

names(income.tract) <- c("tract","income","se")
income.tract$tract= gsub("Census Tract ", "", income.tract$tract)
income.tract$tract= gsub(", Tolland County, Connecticut", "", income.tract$tract)
income.tract$tract= gsub(", Hartford County, Connecticut", "", income.tract$tract)

tracts <- read.csv("../mockup/tracts.csv")
tracts <- merge(tracts, towns, by = "Town")

income.tract <- merge(income.tract, tracts, by = "tract")

ggplot(data = income.tract) + 
  geom_dotplot(aes(x = income, fill = Towngroup), 
               stackgroups = TRUE, binpositions = "all", binwidth = 5700) +
    scale_fill_brewer(name = "Type of town") + 
  scale_x_continuous(labels = comma) + 
  scale_y_continuous(name = "", breaks = NULL) + 
  labs(x = "Neighborhood household income levels") + 
  theme_minimal()
```

--- 
## Education: 3rd grade reading

Source: [SDE](http://sdeportal.ct.gov/Cedar/WEB/ct_report/CMTLandingDT.aspx); availability: 2005-06 - 2010-2011.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
cmt <- read.csv('../testscores/cmt.csv', na.strings = c("**","-"))
cmt <- subset(cmt, cmt$District.ID %in% 
                     levels(as.factor(districts$districtid)))
glravg <- ddply(subset(cmt, Test == "Reading" & Grade == 3),.(District.Name),
                summarise, 
                avg = mean(Standard.CMT.Score.Summary.Average.Scale.Score, na.rm = TRUE))
cmt$District.Name <-factor(cmt$District.Name, levels=glravg[order(-glravg$avg), "District.Name"])

glr_mean <- ddply(subset(cmt, Test == "Reading" & Grade == 3),.(),
                summarise, 
                avg = weighted.mean(Standard.CMT.Score.Summary.Average.Scale.Score,
                                    Number.of.Students.Tested,
                                    na.rm = TRUE))

glr1 <- ggplot() + 
  geom_boxplot(data = subset(cmt, Test == "Reading" & Grade == 3), 
       aes(x = District.Name, 
           y = Standard.CMT.Score.Summary.Average.Scale.Score)) + 
  geom_hline(data = glr_mean, aes(yintercept = avg), alpha = 0.2) +
  coord_flip() + 
  theme_minimal() + 
  labs(x = NULL, y = "Average scale score, 3rd grade reading")

cmt_subgroups <- read.csv('../testscores/cmt-subgroups.csv', na.strings = c("**","-"))
cmt_subgroups <- subset(cmt_subgroups, cmt_subgroups$District.ID %in% 
                     levels(as.factor(districts$districtid)))

#Clean up race categories - make compatible with old categories
cmt_subgroups$Status = gsub(x = cmt_subgroups$Status, 
                                pattern = "American Indian/Alaska Native",
                                replacement = "American Indian")

cmt_subgroups$Status = gsub(x = cmt_subgroups$Status, 
                                pattern = "Black/African American",
                                replacement = "Black, not of Hispanic Origin")

cmt_subgroups$Status = gsub(x = cmt_subgroups$Status, 
                                pattern = "(White$)",
                                replacement = "White, not of Hispanic Origin")

cmt_subgroups <- subset(cmt_subgroups, Students.Tested > 0)

glr2 <- 
ggplot(data = subset(cmt_subgroups, Test == "Reading" & Grade == 3), 
       aes(x = Status, y = Average.Scale.Score)) + 
  geom_boxplot() + 
  coord_flip() + 
  theme_minimal() + 
  labs(x = NULL, y = "Average scale score, 3rd grade reading")

grid.arrange(glr1,glr2,nrow=1)
```
--- 
## Education: chronic absenteeism

Source: [SDE](http://sdeportal.ct.gov/Cedar/); availability: 2012.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
absenteeism <- read.csv("../hodgepodge/CT_ChronicAbsenteeism_2012_SDE-1.csv")
absenteeism <- subset(absenteeism, absenteeism$District.Number %in% levels(as.factor(districts$districtid)))
absenteeism$District <- reorder(absenteeism$District, absenteeism$Students.Chronically.Absent.in.District..Total)

abs1 <- ggplot(data = absenteeism, aes(x = Students.Chronically.Absent.in.District..Total, 
                               y = District)) + 
  geom_point() + 
  theme_minimal() +
  labs(x = "% students chronically absent (2012)", y = NULL)

absenteeism_subgroups <- read.csv('../hodgepodge/subgroups-absenteeism.csv', 
                                  na.strings = c("*"," - "))
absenteeism_subgroups <- subset(absenteeism_subgroups, absenteeism_subgroups$District.Code %in% levels(as.factor(districts$districtid)))
absenteeism_subgroups <- subset(absenteeism_subgroups, CHRONIC.COUNTS >= 0)

abs2 <- ggplot(data = absenteeism_subgroups, aes(x = Statu, y = CHRONIC.PERCENT)) + 
  geom_boxplot() + 
  coord_flip() + 
  theme_minimal() + 
  labs(x = NULL, y = "Percent chronically absent, 2011")

grid.arrange(abs1,abs2,nrow=1)
```
--- 
## Education: high-school graduation

Source: [SDE](http://sdeportal.ct.gov/Cedar/WEB/ResearchandReports/DataBulletins.aspx); availability: 2010-11.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
allgrads <- ddply(subset(hsgrad[1:4], Category %in% c("All Students")),
                  .(District.Name),
                  summarise,
                  rate = mean(X4.Year.Graduation.Rate, na.rm = TRUE))
allgrads$District.Name <- reorder(allgrads$District.Name, -allgrads$rate)
hsgrad1 <- 
  ggplot(data = allgrads, aes(y = District.Name, x = rate)) + 
  geom_point() + 
  xlim(50,100) +
  labs(y = NULL, x = "Four-year graduation rate") + 
  theme_minimal()

hsgrad2 <- ggplot(data = subset(hsgrad, !(Category %in% c("All Students")))) + 
  geom_boxplot(aes(x = Category, y = X4.Year.Graduation.Rate)) + 
  coord_flip() + 
  ylim(50,100) +
  theme_minimal() + 
  labs(x = NULL, y = "Four-year graduation rate")

grid.arrange(hsgrad1,hsgrad2,nrow=1)
```
--- 
## Economy: educational attainment

Source: [Census](http://factfinder2.census.gov/); availability: most recent 2008-2012.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
B23006 = acs.fetch(geography = hartford.towns, table.number = "B23006", col.names = "pretty")

attainbar = data.frame(town=geography(B23006)[[1]],
                        nohs=as.numeric(estimate(B23006[,2])),
                        hsgrad=as.numeric(estimate(B23006[,9])),
                        somecollege=as.numeric(estimate(B23006[,16])),
                        bachelors=as.numeric(estimate(B23006[,23])))
attainbar$town= gsub(" town, Tolland County, Connecticut", "", attainbar$town)
attainbar$town= gsub(" town, Hartford County, Connecticut", "", attainbar$town)
attainbar$town <- reorder(attainbar$town, (attainbar$nohs + attainbar$hsgrad) / (attainbar$nohs + attainbar$hsgrad + attainbar$somecollege + attainbar$bachelors))
attainbar <- melt(attainbar)

ggplot(data = subset(attainbar, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain"))), aes(y = value, x = town, group = variable, fill = variable)) + 
  geom_bar(position = 'fill', stat = 'identity') + 
  scale_y_continuous(labels = percent) +
  labs(x = NULL, y = '% of the population (2008 - 2012 ACS estimates)') +
  scale_fill_brewer(labels = c("Less than high school degree",
                               "High school graduate",
                               "Some college or associate's degree",
                               "Bachelor's degree or higher"),
                    name = "") +
  coord_flip() + 
  theme_minimal()
```

--- 
## Economy: educational attainment (totals)

Source: [Census](http://factfinder2.census.gov/); availability: most recent 2008-2012.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
attainbar = data.frame(town=geography(B23006)[[1]],
                        nohs=as.numeric(estimate(B23006[,2])),
                        hsgrad=as.numeric(estimate(B23006[,9])),
                        somecollege=as.numeric(estimate(B23006[,16])),
                        bachelors=as.numeric(estimate(B23006[,23])))
attainbar$town= gsub(" town, Tolland County, Connecticut", "", attainbar$town)
attainbar$town= gsub(" town, Hartford County, Connecticut", "", attainbar$town)

attainbar$town <- reorder(attainbar$town, 
                          (attainbar$nohs + 
                             attainbar$hsgrad + 
                             attainbar$somecollege + 
                             attainbar$bachelors))
attainbar <- melt(attainbar)

ggplot(data = subset(attainbar, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain"))), aes(y = value, x = town, group = variable, fill = variable)) + 
  geom_bar(position = 'stack', stat = 'identity') + 
  scale_y_continuous(labels = comma) +
  labs(x = NULL, y = 'Adults (2008 - 2012 ACS estimates)') +
  scale_fill_brewer(labels = c("Less than high school degree",
                               "High school graduate",
                               "Some college or associate's degree",
                               "Bachelor's degree or higher"),
                    name = "") +
  coord_flip() + 
  theme_minimal()
```

--- 
## Economy: educational attainment by race

Source: [Census](http://factfinder2.census.gov/); most recent: 2008 - 2012.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 11}
crcog.towns = geo.make(state = "CT", 
                       county = paste(towns$County,"County"),
                       county.subdivision = paste(towns$Town,"town"), 
                       check = F, 
                       combine = T,
                       combine.term = "CRCOG region")

C15002I = acs.fetch(geography = crcog.towns, table.number = "C15002I", col.names = "pretty")
C15002B = acs.fetch(geography = crcog.towns, table.number = "C15002B", col.names = "pretty")
C15002H = acs.fetch(geography = crcog.towns, table.number = "C15002H", col.names = "pretty")

attainment.by.race = 
  rbind(data.frame(town=geography(C15002I)[[1]],
                 race = "Hispanic / Latino",
                 nohs=as.numeric(estimate(divide.acs(
                   numerator=(C15002I[,3] + C15002I[,8]),
                   denominator=(C15002I[,1])))),
                 hs=as.numeric(estimate(divide.acs(
                   numerator=(C15002I[,4] + C15002I[,9]),
                   denominator=(C15002I[,1])))),
                 somecollege=as.numeric(estimate(divide.acs(
                   numerator=(C15002I[,5] + C15002I[,10]),
                   denominator=(C15002I[,1])))),
                 college=as.numeric(estimate(divide.acs(
                   numerator=(C15002I[,6] + C15002I[,11]),
                   denominator=(C15002I[,1]))))),
        data.frame(town=geography(C15002B)[[1]],
                 race = "Black",
                 nohs=as.numeric(estimate(divide.acs(
                   numerator=(C15002B[,3] + C15002B[,8]),
                   denominator=(C15002B[,1])))),
                 hs=as.numeric(estimate(divide.acs(
                   numerator=(C15002B[,4] + C15002B[,9]),
                   denominator=(C15002B[,1])))),
                 somecollege=as.numeric(estimate(divide.acs(
                   numerator=(C15002B[,5] + C15002B[,10]),
                   denominator=(C15002B[,1])))),
                 college=as.numeric(estimate(divide.acs(
                   numerator=(C15002B[,6] + C15002B[,11]),
                   denominator=(C15002B[,1]))))),
      data.frame(town=geography(C15002H)[[1]],
                 race = "White",
                 nohs=as.numeric(estimate(divide.acs(
                   numerator=(C15002H[,3] + C15002H[,8]),
                   denominator=(C15002H[,1])))),
                 hs=as.numeric(estimate(divide.acs(
                   numerator=(C15002H[,4] + C15002H[,9]),
                   denominator=(C15002H[,1])))),
                 somecollege=as.numeric(estimate(divide.acs(
                   numerator=(C15002H[,5] + C15002H[,10]),
                   denominator=(C15002H[,1])))),
                 college=as.numeric(estimate(divide.acs(
                   numerator=(C15002H[,6] + C15002H[,11]),
                   denominator=(C15002H[,1]))))))

attainment.by.race <- melt(attainment.by.race)

ggplot(data = attainment.by.race, 
       aes(y = value, x = race, group = race, fill = variable)) + 
  geom_bar(position = 'fill', stat = 'identity') + 
  scale_y_continuous(labels = percent) +
  labs(x = NULL, y = '% of adults (2008 - 2012 ACS estimates)') +
  scale_fill_brewer(labels = c("Less than high school degree",
                               "High school graduate",
                               "Some college or associate's degree",
                               "Bachelor's degree or higher"), 
                    name = "") +
  coord_flip() + 
  theme_minimal()
```

--- 
## Economy: workforce and unemployment

Sources: [ACS](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B23025&prodType=table)breakouts: age, gender, race / ethnicity, nativity, commuting, others.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
employment$town <- reorder(employment$town, employment$employment)
ue1 <- ggplot(data = (data = subset(employment, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain"))))) + 
  geom_point(aes(x = employment, y = town)) + 
  geom_segment(aes(xend = employment - se.employment, 
                   x = employment + se.employment, 
                   y = town, yend = town), colour = "grey") + 
  labs(x = 'Unemployment rates (2008-2012 ACS estimates)', y = NULL) + 
  scale_x_continuous(labels = percent) + 
  theme_minimal()

employment$town <- reorder(employment$town, employment$participation)
ue2 <- ggplot(data = subset(employment, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain")))) + 
  geom_point(aes(x = participation, y = town)) + 
  geom_segment(aes(xend = participation - se.participation, 
                   x = participation + se.participation, 
                   y = town, yend = town), colour = "grey") + 
  labs(x = '% not in labor force (2008-2012 ACS estimates)', y = NULL) + 
  scale_x_continuous(labels = percent) + 
  theme_minimal()

grid.arrange(ue1,ue2,nrow=1)
```

--- 
## Economy: unemployment by race

Sources: [ACS](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B23025&prodType=table). 

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 7, fig.width = 11}
C23002I = acs.fetch(geography = crcog.towns, table.number = "C23002I", col.names = "pretty")
C23002B = acs.fetch(geography = crcog.towns, table.number = "C23002B", col.names = "pretty")
C23002H = acs.fetch(geography = crcog.towns, table.number = "C23002H", col.names = "pretty")

employment.by.race = 
  rbind(data.frame(town=geography(C23002I)[[1]],
                 race = "Hispanic / Latino",
                 workforce=as.numeric(estimate(C23002I[,3] + C23002I[,16])),
                 uerate=as.numeric(estimate(divide.acs(
                   numerator=(C23002I[,8] + C23002I[,21]),
                   denominator=(C23002I[,4]+C23002I[,17])))),
                 lfrate=as.numeric(estimate(divide.acs(
                   numerator=(C23002I[,9] + C23002I[,22]),
                   denominator=C23002I[,1])))),
        data.frame(town=geography(C23002B)[[1]],
                 race = "Black",
                 workforce=as.numeric(estimate(C23002B[,3] + C23002B[,16])),
                 uerate=as.numeric(estimate(divide.acs(
                   numerator=(C23002B[,8] + C23002B[,21]),
                   denominator=(C23002B[,4]+C23002B[,17])))),
                 lfrate=as.numeric(estimate(divide.acs(
                   numerator=(C23002B[,9] + C23002B[,22]),
                   denominator=C23002B[,1])))),
        data.frame(town=geography(C23002H)[[1]],
               race = "White",
               workforce=as.numeric(estimate(C23002H[,3] + C23002H[,16])),
               uerate=as.numeric(estimate(divide.acs(
                 numerator=(C23002H[,8] + C23002H[,21]),
                 denominator=(C23002H[,4]+C23002H[,17])))),
               lfrate=as.numeric(estimate(divide.acs(
                 numerator=(C23002H[,9] + C23002H[,22]),
                 denominator=C23002H[,1])))))

ggplot(data = subset(
  melt(employment.by.race, id.vars = c("town","race")),variable != "workforce")) + 
  geom_bar(aes(y = value, x = race, fill = variable), position = 'dodge') + 
  labs(y ='Unemployment by race (2007-2011 ACS)', 
       x = NULL) + 
  guides(size = guide_legend(title = "Number of\nworkers")) +
  scale_y_continuous(labels = percent, limits = c(0,.3)) + 
  scale_fill_brewer(name = "Indicator", labels = c("Unemployment rate",
                                                   "Labor force participation")) + 
  theme_minimal() + 
  coord_flip()
```

--- 
## Quality of life: home ownership (by town)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B25008&prodType=table); availability: most recent 2008-2012.

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
B25008 = acs.fetch(geography = hartford.towns, table.number = "B25008", col.names = "pretty")
own.estimate = divide.acs(numerator=B25008[,2],denominator=B25008[,1], method = 'proportion')
homeownership = data.frame(town=geography(B25008)[[1]], 
                         rate=as.numeric(estimate(own.estimate)),
                         se=standard.error(own.estimate))
names(homeownership) <- c("town","rate","se")
homeownership$town= gsub(" town, Tolland County, Connecticut", "", homeownership$town)
homeownership$town= gsub(" town, Hartford County, Connecticut", "", homeownership$town)
homeownership$town <- reorder(homeownership$town, -homeownership$rate)
ggplot(data = subset(homeownership, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain")))) + 
  geom_point(aes(x = rate, y = town)) + 
  geom_segment(aes(xend = rate - se, x = rate + se, y = town, yend = town), colour = "grey") + 
  labs(x = 'Rate of owner-occupied housing (2007-2011 ACS estimates)', y = NULL) + 
  scale_x_continuous(labels = percent) + 
  theme_minimal()
```

--- 
## Quality of life: home ownership (by neighborhood)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B25008&prodType=table).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
B25008 = acs.fetch(geography = hartford.tracts, table.number = "B25008", col.names = "pretty")
own.estimate = divide.acs(numerator=B25008[,2],denominator=B25008[,1], method = 'proportion')
homeownership.tract = data.frame(tract=geography(B25008)[[1]], 
                         rate=as.numeric(estimate(own.estimate)),
                         se=standard.error(own.estimate))
names(homeownership.tract) <- c("tract","rate","se")

homeownership.tract$tract= gsub("Census Tract ", "", homeownership.tract$tract)
homeownership.tract$tract= gsub(", Tolland County, Connecticut", "",
                                homeownership.tract$tract)
homeownership.tract$tract= gsub(", Hartford County, Connecticut", "", 
                                homeownership.tract$tract)

tracts <- read.csv("../mockup/tracts.csv")
tracts <- merge(tracts, towns, by = "Town")

homeownership.tract <- merge(homeownership.tract, tracts, by = "tract")

ggplot(data = homeownership.tract) + 
  geom_dotplot(aes(x = rate, fill = Towngroup, colour = Towngroup), 
               binwidth  = .03, stackgroups = TRUE, binpositions = "all") +
  scale_x_continuous(labels = percent) + 
  scale_y_continuous(name = "", breaks = NULL) + 
  labs(x = "% living in owner-occupied units by neighborhood") + 
  theme_minimal()
```

--- 
## Quality of life: home ownership (by race)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B25008&prodType=table).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 7, fig.width = 11}
B25003I = acs.fetch(geography = crcog.towns, table.number = "B25003I", col.names = "pretty")
B25003B = acs.fetch(geography = crcog.towns, table.number = "B25003B", col.names = "pretty")
B25003H = acs.fetch(geography = crcog.towns, table.number = "B25003H", col.names = "pretty")

homeownership.by.race = rbind(      
  data.frame(town=geography(B25003I)[[1]],
                 race = "Hispanic / Latino",
                 estimate=as.numeric(estimate(B25003I[,2])),
                 rate=as.numeric(estimate(divide.acs(
                   numerator=B25003I[,2],denominator=B25003I[,1])))),
  data.frame(town=geography(B25003B)[[1]],
                 race = "Black",
                 estimate=as.numeric(estimate(B25003B[,2])),
                 rate=as.numeric(estimate(divide.acs(
                   numerator=B25003B[,2],denominator=B25003B[,1])))),
  data.frame(town=geography(B25003H)[[1]],
               race = "White",
               estimate=as.numeric(estimate(B25003H[,2])),
               rate=as.numeric(estimate(divide.acs(
                 numerator=B25003H[,2],denominator=B25003H[,1])))))

ggplot(data = homeownership.by.race) + 
  geom_bar(aes(y = rate, x = race), stat = 'identity') + 
  labs(y ='Homeownership by race (2007-2011 ACS)', 
       x = NULL) + 
  scale_y_continuous(labels = percent, limits = c(0,1)) + 
  scale_fill_brewer(name = "Indicator", labels = c("Homeownership rate")) + 
  theme_minimal() + 
  coord_flip()
```

--- 
## Quality of life: housing and transit cost

Source: [Location Affordability Index](http://lai.locationaffordability.info/).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 7, fig.width = 11}
lai <- read.csv('lai_data_blkgrps.csv')

#ggplot(data = lai_hartford) + 
#  geom_point() + 
#  geom_smooth(aes(x = average_median_commute_distance, y = hh_type1_ht), 
#              method = "loess", se = FALSE) +
#  geom_smooth(aes(x = average_median_commute_distance, y = hh_type1_h, colour = "grey"), 
#              method = "loess", se = FALSE) +
#  geom_smooth(aes(x = average_median_commute_distance, y = hh_type1_t, colour = "green"), 
#              method = "loess", se = FALSE) +
#  labs(y = "% income", x = "Average commuting distance (miles)") + 
#  xlim(0,30) + ylim(0,100) + 
#  theme_minimal() + 
#  facet_wrap(~ CBSA, ncol = 3)

lai_hartford_ht <- melt(subset(lai[c("CBSA","average_median_commute_distance",
                             "hh_type1_ht",
                             "hh_type2_ht",
                             "hh_type3_ht",
                             "hh_type4_ht",
                             "hh_type5_ht",
                             "hh_type6_ht",
                             "hh_type7_ht",
                             "hh_type8_ht")], 
                       CBSA == "Hartford"), 
                     id.vars = c("CBSA","average_median_commute_distance"))

lai_hartford_h <- melt(subset(lai[c("CBSA","average_median_commute_distance",
                             "hh_type1_h",
                             "hh_type2_h",
                             "hh_type3_h",
                             "hh_type4_h",
                             "hh_type5_h",
                             "hh_type6_h",
                             "hh_type7_h",
                             "hh_type8_h")], 
                       CBSA == "Hartford"), 
                     id.vars = c("CBSA","average_median_commute_distance"))

lai_hartford_t <- melt(subset(lai[c("CBSA","average_median_commute_distance",
                             "hh_type1_t",
                             "hh_type2_t",
                             "hh_type3_t",
                             "hh_type4_t",
                             "hh_type5_t",
                             "hh_type6_t",
                             "hh_type7_t",
                             "hh_type8_t")], 
                       CBSA == "Hartford"), 
                     id.vars = c("CBSA","average_median_commute_distance"))

lai_hartford <- cbind(lai_hartford_ht, 
                      lai_hartford_h[4], 
                      lai_hartford_t[4])

names(lai_hartford) <- c("CBSA","average_median_commute_distance","variable",
                         "combined","housing","transit")

lai_hh_types <- list("hh_type1_ht"="Typical",
                     "hh_type2_ht"="Moderate",
                     "hh_type3_ht"="Dual-income\nfamily",
                     "hh_type4_ht"="Low income",
                     "hh_type5_ht"="Single person,\nvery low income",
                     "hh_type6_ht"="Single\nprofessional",
                     "hh_type7_ht"="Single\nworker",
                     "hh_type8_ht"="Retirees")

hhtype_labeller <- function(variable,value){
  return(lai_hh_types[value])
}

ggplot(data = subset(lai_hartford, variable %in% c("hh_type1_ht","hh_type3_ht",
                                                   "hh_type4_ht",
                                                   "hh_type7_ht",
                                                   "hh_type8_ht"))) + 
#  geom_point(aes(x = average_median_commute_distance, y = value)) + 
  geom_smooth(aes(x = average_median_commute_distance, y = combined, colour="black"), 
              method = "loess", se = FALSE) +
  geom_smooth(aes(x = average_median_commute_distance, y = housing, colour="red"), 
              method = "loess", se = FALSE) +
  geom_smooth(aes(x = average_median_commute_distance, y = transit, colour ="green"), 
              method = "loess", se = FALSE) +
  labs(y = "% income", x = "Average commuting distance (miles)",
       title = "Housing and transit costs for commuters") + 
  scale_colour_brewer(labels = c("Combined",
                               "Transit",
                               "Housing"),
                    name = "") +  
  xlim(0,30) + ylim(0,100) + 
  theme_minimal() + 
  facet_grid(~ variable, labeller=hhtype_labeller)
```

--- 
## Quality of life: crime (major CT towns)

Source: [Dept. of Public Safety](http://www.dpsdata.ct.gov/dps/ucr/ucr.aspx); availability: 2001-10; breakouts: property / violent, type of crime

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
totalcrime <- read.csv("../crime/totalcrime.csv")
#totalcrime <- subset(totalcrime, totalcrime$Town %in% levels(towns$Town))
#totalcrime$Town <- factor(totalcrime$Town)
ggplot(data = subset(totalcrime, Town %in% c("Bridgeport","Hartford","New Haven","New Britain","Stamford","Waterbury")), 
       aes(x = Year, y = Total.crime.Rate)) + 
  geom_line(aes(group = Town)) +
  geom_point(aes(shape = Town)) +
  labs(x = NULL, y = "Crime rate by town (per 100K residents)") +
  scale_x_continuous(breaks = c(1998,2004,2010)) + 
  theme_minimal()
```
--- 
## Quality of life: crime (comparison)

Source: [FBI](http://www.ucrdatatool.gov/); availability: 1985-2012; breakouts: property / violent, type of crime

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
ucr <- read.csv("../mockup/UCR-data.csv")
library(reshape)
ucr <- melt(ucr)
ucr$variable= gsub("X", "", ucr$variable)
ucr_all <- ddply(ucr, .(Agency, State, variable), summarise, rate = sum(value))

ggplot(data = ucr, aes(x = variable, y = value)) + 
  geom_line(aes(group = Agency), alpha = 0.2) +
  geom_line(data = subset(ucr, Agency == "Hartford Police Dept"),
            aes(x = variable, y = value, group = Agency))+
  labs(x = "Year", y = "Crime rate (per 100K residents)") +
  scale_x_discrete(breaks = c(1985,1995,2005,2010)) + 
  theme_minimal() + 
  facet_wrap(~ Type, ncol = 1, scales = "free_y")
#subset(ucr, variable == "2012"  & Type == "Violent" & value > 1300)
```
--- 

## Quality of life: crime (within region)

Source: [Dept. of Public Safety](http://www.dpsdata.ct.gov/dps/ucr/ucr.aspx); availability: 2001-10; breakouts: property / violent, type of crime

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
#totalcrime <- subset(totalcrime, totalcrime$Town %in% levels(towns$Town))
#totalcrime$Town <- factor(totalcrime$Town)
totalcrime <- merge(totalcrime, towns, by = "Town")
ggplot(data = ddply(totalcrime, .(Towngroup, Year), summarise, 
      Total.crime.Rate = weighted.mean(Total.crime.Rate, 
                                       Total.estimated.population..Number)), 
       aes(x = Year, y = Total.crime.Rate)) + 
  geom_line(aes(group = Towngroup)) +
  geom_point(aes(shape = Towngroup)) +
  labs(x = NULL, y = "Crime rate by town (per 100K residents)") +
  scale_x_continuous(breaks = c(1998,2004,2010)) + 
  theme_minimal()
```
--- 
## Quality of life: voter turnout

Source: [CT Secretary of State](http://www.ct.gov/sots/cwp/view.asp?a=3179&q=392194)

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 14}
voting <- read.csv('2012-voting.csv')
voting <- subset(voting, voting$Town %in% levels(towns$Town))
voting$Town <- factor(voting$Town)

voting$Town <- reorder(voting$Town, -voting$Percentage.Checked.as.Having.Voted)

ggplot(data = voting) + 
  geom_point(aes(x = Percentage.Checked.as.Having.Voted, y = Town)) + 
  labs(x = '% checked as having voted (11/6/2012 election)', y = NULL) + 
  scale_x_continuous(labels = percent) + 
  theme_minimal()
```

--- 
## Quality of life: voter turnout

Source: [HartfordInfo](http://hartfordinfo.org/).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 14}
hartford_voting <- read.csv('hartford-voting.csv')
hartford_voting$Voting.District <- paste("Hartford", hartford_voting$Voting.District, "Voting District")

hartford_voting <- ddply(hartford_voting, .(Voting.District), summarise, 
                         turnout = mean(Ratio.to.city.average))

hartford_voting$Voting.District <- reorder(hartford_voting$Voting.District, -hartford_voting$turnout)

#vote2 <- ggplot(data = hartford_voting) + 
#  geom_point(aes(x = turnout, y = Voting.District)) + 
#  labs(x = 'Voter turnout relative to city turnout (all elections, 2002 - 2012)', y #= "Voting District") + 
#  scale_x_continuous(labels = percent) + 
#  theme_minimal()

#Load the districts shapefile
CTDistricts <- readShapeSpatial(fn="../votingdistrictct_37800_0000_2010_s100_census_1_shp/votingdistrictct_37800_0000_2010_s100_census_1_shp/WGS84/votingdistrictct_37800_0000_2010_s100_census_1_shp_wgs84")

#Fortify and order the districts to allow ggmap to use that
CTDistricts <- fortify(CTDistricts, region = "NAMELSAD10")
#CTDistricts <- CTDistricts[order(CTDistricts$order),]

library(classInt)
jenks <- classIntervals(hartford_voting$turnout, n=4, style="fisher")
choropleth=merge(CTDistricts, hartford_voting, by.x = "id", by.y="Voting.District")
choropleth=choropleth[order(choropleth$order), ]
choropleth$turnout=cut(choropleth$turnout, breaks=jenks$brks, include.lowest=T, dig.lab = T)

#Make the map
ggplot(data = choropleth, aes(long, lat, group = group)) +
  geom_polygon(aes(fill = turnout)) + 
  scale_x_continuous(breaks = NULL) +
  scale_y_continuous(breaks = NULL) +
  labs(x = NULL, y = NULL, title = 'Voter turnout relative\n to city turnout by district\n(all elections, 2002 - 2012)') + 
  coord_equal() +
#  geom_polygon(data = CTTowns, colour = "grey", alpha = 0.5, fill = NA) +
  scale_fill_brewer(palette = "Purples", name = "Voter turnout\nrelative to city average") +
  theme_minimal()
```
