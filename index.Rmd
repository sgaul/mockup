---
title       : Mockup of top indicators
subtitle    : Hartford regional data and indicators
author      : 
job         : Community Indicators Project
framework   : io2012        # {io2012, html5slides, shower, dzslides, minimal ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      # 
ext_widgets : {rCharts: ["libraries/nvd3"]} 
mode        : selfcontained # {standalone, draft}
---
## Who are we: nativity

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_12_1YR_DP02&prodType=table); availability: most recent 2007-2011; breakouts: ancestry or place of birth.

![image](../mockup/placeofbirth.png)

--- 
## Who are we: languages in school

Source: [SDE](http://sdeportal.ct.gov/Cedar/WEB/ct_report/EllDT.aspx); availability: 2000-01 - 2010-11; breakouts: none.

![image](../mockup/languages-4.png)

--- 
## Who are we: school enrollment

Source: [SDE](http://sdeportal.ct.gov/Cedar/WEB/ct_report/EnrollmentDT.aspx); availability: 2006-07 - 2010-11; breakouts: type of school

```{r echo = FALSE, warning = FALSE, message = FALSE}
enrollflow <- read.csv("../regionalreport/data/all-schools.csv", stringsAsFactors=FALSE)

enrollflow <- subset(enrollflow, enrollflow$Resident.Town %in% levels(towns$Town))
enrollflow$Resident.Town <- factor(enrollflow$Resident.Town)

charters <- data.frame(charters = c("The Bridge Academy District",
                            "Trailblazers Academy District",
                            "Side By Side Community School District",
                            "Park City Prep Charter School",
                            "Odyssey Community School District",
                            "New Beginnings Inc., Family Academy District",
                            "Jumoke Academy District",
                            "Highville Charter School District",  
                            "Highville Mustard Seed Charter School District",       
                            "Integrated Day Charter School District",        
                            "Interdistrict School for Arts and Comm District",
                            "Explorations District",
                            "Elm City College Preparatory School",
                            "Common Ground High School District",
                            "Charter School for Young Children on Asylum Hill",
                            "Bridgeport Achievement First",
                            "Achievement First Hartford Academy Inc.",                
                            "Amistad Academy District"))

#Make the charters into their own category
enrollflow$School.Type[enrollflow$Sent.to.District %in% levels(charters[,])] <- 'Public charter'

enrollflow$Town.Type <- ifelse(enrollflow$Resident.Town %in% c("Bloomfield","East Hartford","East Windsor","Manchester","Vernon","Windsor","Windsor Locks"), "Towns with Alliance District","Other towns")

enrollflow$Town.Type <- ifelse(enrollflow$Resident.Town %in% c("Hartford"),"Hartford",enrollflow$Town.Type)

enrollflow <- ddply(enrollflow, .(Town.Type, School.Type), summarise, sum = sum(Total))

#write.csv(enrollflow, "enrollflow.csv", row.names = FALSE)
#Next command: write.csv(subset(otm, ratio > 0.05 & !(Destination == "All Other Locations")), "commute.csv", row.names = FALSE)
```

![image](../mockup/enrollment.png)

--- 
## Who are we: commuting patterns

Source: [Census / DoL](http://onthemap.ces.census.gov/); availability: 2002 - 2011; breakouts: age, income, sector

![image](../mockup/commute-patterns.png)

--- 
## Who are we: poverty and income

Source: [Census](http://factfinder2.census.gov/); availability: most recent 2007-2011; breakouts: age, gender, race / ethnicity, commuting, others

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 11}
library(gridExtra)
library(scales)

income$town <- reorder(income$town, -income$income)
inc1 <- ggplot(data = subset(income, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain")))) + 
  geom_point(aes(x = income, y = town)) + 
  geom_segment(aes(xend = income - se, x = income + se, y = town, yend = town), colour = "grey") + 
  labs(x = 'Median household income', y = NULL) + 
  scale_x_continuous(labels = comma) + 
  theme_minimal()

library(acs)
library(maps)
library(maptools)
key = "ba67d3a427e1f785987b9c8bc59341bf7c8a7cc1"
api.key.install(key)
#hartford.towns = geo.make(state = "CT", county = c("Hartford","Tolland"), county.subdivision = "*", check = T)
B17001 = acs.fetch(geography = hartford.towns, table.number = "B17001", col.names = "pretty")
poverty.estimate = divide.acs(numerator=B17001[,2],denominator=B17001[,1], method = 'proportion')
povertyacs = data.frame(town=geography(B17001)[[1]], 
                         rate=as.numeric(estimate(poverty.estimate)),
                         se=standard.error(poverty.estimate))
names(povertyacs) <- c("town","rate","se")
povertyacs$town= gsub(" town, Tolland County, Connecticut", "", povertyacs$town)
povertyacs$town= gsub(" town, Hartford County, Connecticut", "", povertyacs$town)
povertyacs$town <- reorder(povertyacs$town, povertyacs$rate)

inc2 <- ggplot(data = subset(povertyacs, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain")))) + 
  geom_point(aes(x = rate, y = town)) + 
  geom_segment(aes(xend = rate - se, x = rate + se, y = town, yend = town), colour = "grey") + 
  labs(x = '% living under federal poverty line (2007-2011 ACS estimates)', y = NULL) + 
  scale_x_continuous(labels = percent) + 
  theme_minimal()

grid.arrange(inc1,inc2,nrow=1)
```

--- 
## Who are we: poverty and income (2)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B19001&prodType=table); availability: most recent 2007-2011; breakouts: gender, race / ethnicity, others

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 11}
library(reshape)
library(ggplot2)
library(scales)
distn <- melt(read.csv('income-levels.csv'))

distn$Geography <- factor(distn$Geography, levels = c("Less than $25,000",
                                                      "$25,000 to $49,999",
                                                      "$50,000 to $74,999",
                                                      "$75,000 to $99,999",
                                                      "$100,000 to $124,999",
                                                      "$125,000 to $149,999",
                                                      "$150,000 to $199,999",
                                                      "$200,000 or more"))


ggplot(data = subset(distn, Stat == "Estimate" & Subgroup == "All" & variable !="CRCOG")) + 
  geom_line(aes(x = Geography, y = value, group = variable, colour = variable)) + 
  labs(x = "Household income", y = "Number of households") + 
  scale_y_continuous(labels = comma) +
  theme_minimal()
```

--- 
## Who are we: poverty and income (3)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B19001&prodType=table); availability: most recent 2007-2011; breakouts: gender, race / ethnicity, others

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 11}
ggplot(data = subset(distn, Stat == "Percent" & Subgroup == "All" & variable !="CRCOG")) + 
  geom_line(aes(x = Geography, y = value, group = variable, colour = variable)) + 
  labs(x = "Household income", y = "Percent of households") + 
  scale_y_continuous(labels = percent) +
  theme_minimal()
```

--- 
## Who are we: poverty and income (4)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B19001&prodType=table); availability: most recent 2007-2011; breakouts: gender, race / ethnicity, others

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 11}
ggplot(data = subset(distn, Stat == "Estimate" & Subgroup != "All" & variable =="CRCOG")) + 
  geom_line(aes(x = Geography, y = value, group = Subgroup, colour = Subgroup)) + 
  labs(x = "Household income", y = "Number of households") + 
  scale_y_continuous(labels = comma) +
  theme_minimal()
```

--- 
## Who are we: poverty and income (5)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B19001&prodType=table); availability: most recent 2007-2011; breakouts: gender, race / ethnicity, others

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 11}
ggplot(data = subset(distn, Stat == "Percent" & Subgroup != "All" & variable =="CRCOG")) + 
  geom_line(aes(x = Geography, y = value, group = Subgroup, colour = Subgroup)) + 
  labs(x = "Household income", y = "Percent of households") + 
  scale_y_continuous(labels = percent) +
  theme_minimal()
```

--- 
## Who we are: income (by neighborhood)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B19001&prodType=table).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 7, fig.width = 11}
B19013 = acs.fetch(geography = hartford.tracts, table.number = "B19013", col.names = "pretty")

income.tract = data.frame(tract=geography(B19013)[,1],
                    income.estimate = estimate(B19013[,1]),
                    se=standard.error(B19013[,1]))

names(income.tract) <- c("tract","income","se")
income.tract$tract= gsub("Census Tract ", "", income.tract$tract)
income.tract$tract= gsub(", Tolland County, Connecticut", "", income.tract$tract)
income.tract$tract= gsub(", Hartford County, Connecticut", "", income.tract$tract)

tracts <- read.csv("../mockup/tracts.csv")

income.tract <- merge(income.tract, tracts, by = "tract")

ggplot(data = subset(income.tract, !(Town %in% c("New Britain","Bristol")))) + 
  geom_dotplot(aes(x = income, fill = Town, colour = Town), 
               stackgroups = TRUE, binpositions = "all", binwidth = 6000) +
  scale_x_continuous(labels = comma) + 
  scale_y_continuous(name = "", breaks = NULL) + 
  labs(x = "Neighborhoods by median household income") + 
  theme_minimal()
```

--- 
## Education: 3rd grade reading

Source: [SDE](http://sdeportal.ct.gov/Cedar/WEB/ct_report/CMTLandingDT.aspx); availability: 2005-06 - 2010-2011; breakouts: ELL, special-education status, gender, race / ethnicity, free / reduced-price lunch eligibility

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
cmt <- read.csv('../testscores/cmt.csv', na.strings = c("**","-"))
cmt <- subset(cmt, cmt$District.ID %in% 
                     levels(as.factor(districts$districtid)))
glravg <- ddply(subset(cmt, Test == "Reading" & Grade == 3),.(District.Name),
                summarise, 
                avg = mean(Standard.CMT.Score.Summary.Average.Scale.Score, na.rm = TRUE))
cmt$District.Name <-factor(cmt$District.Name, levels=glravg[order(-glravg$avg), "District.Name"])
glr1 <- ggplot(data = subset(cmt, Test == "Reading" & Grade == 3), 
       aes(x = District.Name, 
           y = Standard.CMT.Score.Summary.Percent.at.above.Goal.level)) + 
  geom_boxplot() + 
  coord_flip() + 
  theme_minimal() + 
  labs(x = NULL, y = "Percent above goal, 3rd grade reading")

cmt_subgroups <- read.csv('../testscores/cmt-subgroups.csv', na.strings = c("**","-"))
cmt_subgroups <- subset(cmt_subgroups, cmt_subgroups$District.ID %in% 
                     levels(as.factor(districts$districtid)))

#Clean up race categories - make compatible with old categories
cmt_subgroups$Status = gsub(x = cmt_subgroups$Status, 
                                pattern = "American Indian/Alaska Native",
                                replacement = "American Indian")

cmt_subgroups$Status = gsub(x = cmt_subgroups$Status, 
                                pattern = "Black/African American",
                                replacement = "Black, not of Hispanic Origin")

cmt_subgroups$Status = gsub(x = cmt_subgroups$Status, 
                                pattern = "(White$)",
                                replacement = "White, not of Hispanic Origin")

cmt_subgroups <- subset(cmt_subgroups, Students.Tested > 0)

glr2 <- 
ggplot(data = subset(cmt_subgroups, Test == "Reading" & Grade == 3), 
       aes(x = Status, y = Percent.at.or.Above.Goal)) + 
  geom_boxplot() + 
  coord_flip() + 
  theme_minimal() + 
  labs(x = NULL, y = "Percent at or above goal, 3rd grade reading")

grid.arrange(glr1,glr2,nrow=1)
```
--- 
## Education: chronic absenteeism

Source: [SDE](http://sdeportal.ct.gov/Cedar/); availability: 2012; breakouts: ELL, special-education status, gender, race / ethnicity, free / reduced-price lunch eligibility

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
absenteeism <- read.csv("../hodgepodge/CT_ChronicAbsenteeism_2012_SDE-1.csv")
absenteeism <- subset(absenteeism, absenteeism$District.Number %in% levels(as.factor(districts$districtid)))
absenteeism$District <- reorder(absenteeism$District, absenteeism$Students.Chronically.Absent.in.District..Total)

abs1 <- ggplot(data = absenteeism, aes(x = Students.Chronically.Absent.in.District..Total, 
                               y = District)) + 
  geom_point() + 
  theme_minimal() +
  labs(x = "% students chronically absent (2012)", y = NULL)

absenteeism_subgroups <- read.csv('../hodgepodge/subgroups-absenteeism.csv', 
                                  na.strings = c("*"," - "))
absenteeism_subgroups <- subset(absenteeism_subgroups, absenteeism_subgroups$District.Code %in% levels(as.factor(districts$districtid)))
absenteeism_subgroups <- subset(absenteeism_subgroups, CHRONIC.COUNTS >= 0)

abs2 <- ggplot(data = absenteeism_subgroups, aes(x = Statu, y = CHRONIC.PERCENT)) + 
  geom_boxplot() + 
  coord_flip() + 
  theme_minimal() + 
  labs(x = NULL, y = "Percent chronically absent, 2011")

grid.arrange(abs1,abs2,nrow=1)
```
--- 
## Education: high-school graduation

Source: [SDE](http://sdeportal.ct.gov/Cedar/WEB/ResearchandReports/DataBulletins.aspx); availability: 2010-11; breakouts: ELL, special-education status, gender, race / ethnicity, free / reduced-price lunch eligibility

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
allgrads <- ddply(subset(hsgrad[1:4], Category %in% c("All Students")),
                  .(District.Name),
                  summarise,
                  rate = mean(X4.Year.Graduation.Rate, na.rm = TRUE))
allgrads$District.Name <- reorder(allgrads$District.Name, -allgrads$rate)
hsgrad1 <- 
  ggplot(data = allgrads, aes(y = District.Name, x = rate)) + 
  geom_point() + 
  xlim(50,100) +
  labs(y = NULL, x = "Four-year graduation rate") + 
  theme_minimal()

hsgrad2 <- ggplot(data = subset(hsgrad, !(Category %in% c("All Students")))) + 
  geom_boxplot(aes(x = Category, y = X4.Year.Graduation.Rate)) + 
  coord_flip() + 
  ylim(50,100) +
  theme_minimal() + 
  labs(x = NULL, y = "Four-year graduation rate")

grid.arrange(hsgrad1,hsgrad2,nrow=1)
```
--- 
## Economy: educational attainment

Source: [Census](http://factfinder2.census.gov/); availability: most recent 2007-2011; breakouts: age, gender, race / ethnicity, commuting, others

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
B23006 = acs.fetch(geography = hartford.towns, table.number = "B23006", col.names = "pretty")

attainbar = data.frame(town=geography(B23006)[[1]],
                        nohs=as.numeric(estimate(B23006[,2])),
                        hsgrad=as.numeric(estimate(B23006[,9])),
                        somecollege=as.numeric(estimate(B23006[,16])),
                        bachelors=as.numeric(estimate(B23006[,23])))
attainbar$town= gsub(" town, Tolland County, Connecticut", "", attainbar$town)
attainbar$town= gsub(" town, Hartford County, Connecticut", "", attainbar$town)
attainbar$town <- reorder(attainbar$town, (attainbar$nohs + attainbar$hsgrad) / (attainbar$nohs + attainbar$hsgrad + attainbar$somecollege + attainbar$bachelors))
attainbar <- melt(attainbar)

ggplot(data = subset(attainbar, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain"))), aes(y = value, x = town, group = variable, fill = variable)) + 
  geom_area(position = 'fill') + 
  scale_y_continuous(labels = percent) +
  labs(x = NULL, y = '% of the population (2007 - 2011 ACS estimates)') +
  scale_fill_brewer(labels = c("Less than high school degree",
                               "High school graduate",
                               "Some college or associate's degree",
                               "Bachelor's degree or higher")) +
  coord_flip() + 
  theme_minimal()
```

--- 
## Economy: educational attainment by race

Source: [Census](http://factfinder2.census.gov/)

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.width = 11}
B23006 = acs.fetch(geography = hartford.towns, table.number = "B23006", col.names = "pretty")

attainbar = data.frame(town=geography(B23006)[[1]],
                        nohs=as.numeric(estimate(B23006[,2])),
                        hsgrad=as.numeric(estimate(B23006[,9])),
                        somecollege=as.numeric(estimate(B23006[,16])),
                        bachelors=as.numeric(estimate(B23006[,23])))
attainbar$town= gsub(" town, Tolland County, Connecticut", "", attainbar$town)
attainbar$town= gsub(" town, Hartford County, Connecticut", "", attainbar$town)
attainbar$town <- reorder(attainbar$town, (attainbar$nohs + attainbar$hsgrad) / (attainbar$nohs + attainbar$hsgrad + attainbar$somecollege + attainbar$bachelors))
attainbar <- melt(attainbar)

ggplot(data = subset(attainbar, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain"))), aes(y = value, x = town, group = variable, fill = variable)) + 
  geom_area(position = 'fill') + 
  scale_y_continuous(labels = percent) +
  labs(x = NULL, y = '% of the population (2007 - 2011 ACS estimates)') +
  scale_fill_brewer(labels = c("Less than high school degree",
                               "High school graduate",
                               "Some college or associate's degree",
                               "Bachelor's degree or higher")) +
  coord_flip() + 
  theme_minimal()
```


--- 
## Economy: workforce and unemployment

Sources: [ACS](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B23025&prodType=table), [BLS](http://www1.ctdol.state.ct.us/lmi/LAUS/default.asp); ACS: most recent 2007-11; BLS: 1994 - 2013; breakouts: age, gender, race / ethnicity, nativity, commuting, others (ACS only).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
employment$town <- reorder(employment$town, employment$employment)
ue1 <- ggplot(data = (data = subset(employment, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain"))))) + 
  geom_point(aes(x = employment, y = town)) + 
  geom_segment(aes(xend = employment - se.employment, 
                   x = employment + se.employment, 
                   y = town, yend = town), colour = "grey") + 
  labs(x = 'Unemployment rates (2007-2011 ACS estimates)', y = NULL) + 
  scale_x_continuous(labels = percent) + 
  theme_minimal()

employment$town <- reorder(employment$town, employment$participation)
ue2 <- ggplot(data = subset(employment, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain")))) + 
  geom_point(aes(x = participation, y = town)) + 
  geom_segment(aes(xend = participation - se.participation, 
                   x = participation + se.participation, 
                   y = town, yend = town), colour = "grey") + 
  labs(x = '% not in labor force (2007-2011 ACS estimates)', y = NULL) + 
  scale_x_continuous(labels = percent) + 
  theme_minimal()

grid.arrange(ue1,ue2,nrow=1)
```

--- 
## Economy: unemployment by race

Sources: [ACS](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B23025&prodType=table). 

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 7, fig.width = 11}
#Additional references
#EDUCATIONAL ATTAINMENT AND EMPLOYMENT STATUS BY LANGUAGE SPOKEN AT HOME FOR THE POPULATION 25 YEARS AND OVER: http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_12_5YR_B16010&prodType=table

#EDUCATIONAL ATTAINMENT BY EMPLOYMENT STATUS FOR THE POPULATION 25 TO 64 YEARS: http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_12_5YR_B23006&prodType=table

C23002I = acs.fetch(geography = hartford.towns, table.number = "C23002I", col.names = "pretty")
ue.h.estimate = divide.acs(numerator=(C23002I[,8] + C23002I[,21]),
                           denominator=(C23002I[,4]+C23002I[,17]))
lf.h.estimate = divide.acs(numerator=(C23002I[,9] + C23002I[,22]),denominator=C23002I[,1])
C23002B = acs.fetch(geography = hartford.towns, table.number = "C23002B", col.names = "pretty")
ue.b.estimate = divide.acs(numerator=(C23002B[,8] + C23002B[,21]),
                           denominator=(C23002B[,4]+C23002B[,17]))
lf.b.estimate = divide.acs(numerator=(C23002B[,9] + C23002B[,22]),denominator=C23002B[,1])
C23002H = acs.fetch(geography = hartford.towns, table.number = "C23002H", col.names = "pretty")
ue.w.estimate = divide.acs(numerator=(C23002H[,8] + C23002H[,21]),
                           denominator=(C23002H[,4]+C23002H[,17]))
lf.w.estimate = divide.acs(numerator=(C23002H[,9] + C23002H[,22]),denominator=C23002H[,1])

employment.by.race = 
  merge(
    merge(
      data.frame(town=geography(C23002I)[[1]],
                 race = "Hispanic / Latino",
                 workforce=as.numeric(estimate(C23002I[,3] + C23002I[,16])),
                 uerate=as.numeric(estimate(ue.h.estimate)),
                 lfrate=as.numeric(estimate(lf.h.estimate))),
      data.frame(town=geography(C23002B)[[1]],
                 race = "Black",
                 workforce=as.numeric(estimate(C23002B[,3] + C23002B[,16])),
                 uerate=as.numeric(estimate(ue.b.estimate)),
                 lfrate=as.numeric(estimate(lf.b.estimate))),
      by = "town"),
    data.frame(town=geography(C23002H)[[1]],
               race = "White",
               workforce=as.numeric(estimate(C23002H[,3] + C23002H[,16])),
               uerate=as.numeric(estimate(ue.w.estimate)),
               lfrate=as.numeric(estimate(lf.w.estimate))),
    by = "town")

employment.by.race$town= gsub(" town, Tolland County, Connecticut", "", 
                                 employment.by.race$town)
employment.by.race$town= gsub(" town, Hartford County, Connecticut", "", 
                                 employment.by.race$town)

employment.by.race$town <- reorder(employment.by.race$town,
                                      (employment.by.race$workforce.x + 
                                         employment.by.race$workforce.y))

ggplot(data = subset(employment.by.race, (workforce.x + workforce.y) > 2000 & !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain")))) + 
  geom_text(aes(x = uerate, y = town, size = workforce), label = "White") + 
  geom_text(aes(x = uerate.x, y = town, size = workforce.x), label = "Latino") + 
  geom_text(aes(x = uerate.y, y = town, size = workforce.y), label = "Black") + 
  labs(x ='Unemployment by race (2007-2011 ACS)', 
       y = NULL) + 
  guides(size = guide_legend(title = "Number of\nworkers")) +
  scale_x_continuous(labels = percent) + 
  theme_minimal()
```

--- 
## Quality of life: home ownership (by town)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B25008&prodType=table); availability: most recent 2007-2011

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
B25008 = acs.fetch(geography = hartford.towns, table.number = "B25008", col.names = "pretty")
own.estimate = divide.acs(numerator=B25008[,2],denominator=B25008[,1], method = 'proportion')
homeownership = data.frame(town=geography(B25008)[[1]], 
                         rate=as.numeric(estimate(own.estimate)),
                         se=standard.error(own.estimate))
names(homeownership) <- c("town","rate","se")
homeownership$town= gsub(" town, Tolland County, Connecticut", "", homeownership$town)
homeownership$town= gsub(" town, Hartford County, Connecticut", "", homeownership$town)
homeownership$town <- reorder(homeownership$town, -homeownership$rate)
ggplot(data = subset(homeownership, !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain")))) + 
  geom_point(aes(x = rate, y = town)) + 
  geom_segment(aes(xend = rate - se, x = rate + se, y = town, yend = town), colour = "grey") + 
  labs(x = 'Rate of owner-occupied housing (2007-2011 ACS estimates)', y = NULL) + 
  scale_x_continuous(labels = percent) + 
  theme_minimal()
```

--- 
## Quality of life: home ownership (by neighborhood)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B25008&prodType=table).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
B25008 = acs.fetch(geography = hartford.tracts, table.number = "B25008", col.names = "pretty")
own.estimate = divide.acs(numerator=B25008[,2],denominator=B25008[,1], method = 'proportion')
homeownership.tract = data.frame(tract=geography(B25008)[[1]], 
                         rate=as.numeric(estimate(own.estimate)),
                         se=standard.error(own.estimate))
names(homeownership.tract) <- c("tract","rate","se")

homeownership.tract$tract= gsub("Census Tract ", "", homeownership.tract$tract)
homeownership.tract$tract= gsub(", Tolland County, Connecticut", "",
                                homeownership.tract$tract)
homeownership.tract$tract= gsub(", Hartford County, Connecticut", "", 
                                homeownership.tract$tract)
tracts <- read.csv("../mockup/tracts.csv")

homeownership.tract <- merge(homeownership.tract, tracts, by = "tract")

ggplot(data = subset(homeownership.tract, !(Town %in% c("New Britain","Bristol")))) + 
  geom_dotplot(aes(x = rate, fill = Town, colour = Town), 
               binwidth  = .035, stackgroups = TRUE, binpositions = "all") +
  scale_x_continuous(labels = percent) + 
  scale_y_continuous(name = "", breaks = NULL) + 
  labs(x = "Neighborhoods by % living in owner-occupied units") + 
  theme_minimal()
```

--- 
## Quality of life: home ownership (by race)

Source: [Census](http://factfinder2.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_11_5YR_B25008&prodType=table).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 7, fig.width = 11}
B25003I = acs.fetch(geography = hartford.towns, table.number = "B25003I", col.names = "pretty")
own.h.estimate = divide.acs(numerator=B25003I[,2],denominator=B25003I[,1])
B25003B = acs.fetch(geography = hartford.towns, table.number = "B25003B", col.names = "pretty")
own.b.estimate = divide.acs(numerator=B25003B[,2],denominator=B25003B[,1])
B25003H = acs.fetch(geography = hartford.towns, table.number = "B25003H", col.names = "pretty")
own.w.estimate = divide.acs(numerator=B25003H[,2],denominator=B25003H[,1])

homeownership.by.race = 
  merge(
    merge(
      data.frame(town=geography(B25003I)[[1]],
                 race = "Hispanic / Latino",
                 estimate=as.numeric(estimate(B25003I[,2])),
                 rate=as.numeric(estimate(own.h.estimate))),
      data.frame(town=geography(B25003B)[[1]],
                 race = "Black",
                 estimate=as.numeric(estimate(B25003B[,2])),
                 rate=as.numeric(estimate(own.b.estimate))),
      by = "town"),
    data.frame(town=geography(B25003H)[[1]],
               race = "White",
               estimate=as.numeric(estimate(B25003H[,2])),
               rate=as.numeric(estimate(own.w.estimate))),
    by = "town")

homeownership.by.race$town= gsub(" town, Tolland County, Connecticut", "", 
                                 homeownership.by.race$town)
homeownership.by.race$town= gsub(" town, Hartford County, Connecticut", "", 
                                 homeownership.by.race$town)

homeownership.by.race$town <- reorder(homeownership.by.race$town,
                                      (homeownership.by.race$estimate.x + homeownership.by.race$estimate.y))

ggplot(data = subset(homeownership.by.race, (estimate.x + estimate.y) > 500 & !(town %in% c("Burlington","Columbia","Coventry","Hartland","Berlin","Union","Southington","Mansfield","Willington","Plainville","Bristol","New Britain")))) + 
  geom_text(aes(x = rate, y = town, size = estimate), label = "White") + 
  geom_text(aes(x = rate.x, y = town, size = estimate.x), label = "Latino") + 
  geom_text(aes(x = rate.y, y = town, size = estimate.y), label = "Black") + 
  labs(x ='Rate of owner-occupied housing by race (2007-2011 ACS)', 
       y = NULL) + 
  guides(size = guide_legend(title = "Number of\nhouseholds")) +
  scale_x_continuous(labels = percent, limits = c(0,1)) + 
  theme_minimal()
```

--- 
## Quality of life: housing and transit cost

Source: [Location Affordability Index](http://lai.locationaffordability.info/).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 7, fig.width = 11}
lai <- read.csv('lai_data_blkgrps.csv')

#ggplot(data = lai_hartford) + 
#  geom_point() + 
#  geom_smooth(aes(x = average_median_commute_distance, y = hh_type1_ht), 
#              method = "loess", se = FALSE) +
#  geom_smooth(aes(x = average_median_commute_distance, y = hh_type1_h, colour = "grey"), 
#              method = "loess", se = FALSE) +
#  geom_smooth(aes(x = average_median_commute_distance, y = hh_type1_t, colour = "green"), 
#              method = "loess", se = FALSE) +
#  labs(y = "% income", x = "Average commuting distance (miles)") + 
#  xlim(0,30) + ylim(0,100) + 
#  theme_minimal() + 
#  facet_wrap(~ CBSA, ncol = 3)

lai_hartford <- melt(subset(lai[c("CBSA","average_median_commute_distance",
                             "hh_type1_ht",
                             "hh_type2_ht",
                             "hh_type3_ht",
                             "hh_type4_ht",
                             "hh_type5_ht",
                             "hh_type6_ht",
                             "hh_type7_ht",
                             "hh_type8_ht")], 
                       CBSA == "Hartford"), 
                     id.vars = c("CBSA","average_median_commute_distance"))

lai_hh_types <- list("hh_type1_ht"="Typical",
                     "hh_type2_ht"="Moderate",
                     "hh_type3_ht"="Dual-income\nfamily",
                     "hh_type4_ht"="Low income",
                     "hh_type5_ht"="Single person,\nvery low income",
                     "hh_type6_ht"="Single\nprofessional",
                     "hh_type7_ht"="Single\nworker",
                     "hh_type8_ht"="Retirees")

hhtype_labeller <- function(variable,value){
  return(lai_hh_types[value])
}


ggplot(data = lai_hartford) + 
#  geom_point(aes(x = average_median_commute_distance, y = value)) + 
  geom_smooth(aes(x = average_median_commute_distance, y = value), 
              method = "loess", se = FALSE) +
  labs(y = "% income", x = "Average commuting distance (miles)") + 
  xlim(0,30) + ylim(0,200) + 
  theme_minimal() + 
  facet_grid(~ variable, labeller=hhtype_labeller)
```

--- 
## Quality of life: crime (comparison)

Source: [Dept. of Public Safety](http://www.dpsdata.ct.gov/dps/ucr/ucr.aspx); availability: 2001-10; breakouts: property / violent, type of crime

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
totalcrime <- read.csv("../crime/totalcrime.csv")
#totalcrime <- subset(totalcrime, totalcrime$Town %in% levels(towns$Town))
#totalcrime$Town <- factor(totalcrime$Town)
ggplot(data = subset(totalcrime, Town %in% c("Bridgeport","Hartford","New Haven","New London","Stamford","Waterbury")), 
       aes(x = Year, y = Total.crime.Rate)) + 
  geom_line(aes(group = Town)) +
  geom_point(aes(shape = Town)) +
  labs(x = NULL, y = "Crime rate by town (per 100K residents)") +
  scale_x_continuous(breaks = c(1998,2004,2010)) + 
  theme_minimal()
```
--- 
## Quality of life: crime (comparison)

Source: [FBI](http://www.ucrdatatool.gov/); availability: 1985-2012; breakouts: property / violent, type of crime

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
ucr <- read.csv("../mockup/UCR-data.csv")
library(reshape)
ucr <- melt(ucr)
ucr$variable= gsub("X", "", ucr$variable)
ucr_all <- ddply(ucr, .(Agency, State, variable), summarise, rate = sum(value))

ggplot(data = ucr, aes(x = variable, y = value)) + 
  geom_line(aes(group = Agency), alpha = 0.2) +
  geom_line(data = subset(ucr, Agency == "Hartford Police Dept"),
            aes(x = variable, y = value, group = Agency))+
  labs(x = "Year", y = "Crime rate (per 100K residents)") +
  scale_x_discrete(breaks = c(1985,1995,2005,2010)) + 
  theme_minimal() + 
  facet_wrap(~ Type, ncol = 1, scales = "free_y")
#subset(ucr, variable == "2012"  & Type == "Violent" & value > 1300)
```
--- 

## Quality of life: crime (within region)

Source: [Dept. of Public Safety](http://www.dpsdata.ct.gov/dps/ucr/ucr.aspx); availability: 2001-10; breakouts: property / violent, type of crime

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
#totalcrime <- subset(totalcrime, totalcrime$Town %in% levels(towns$Town))
#totalcrime$Town <- factor(totalcrime$Town)
totalcrime <- merge(totalcrime, towns, by = "Town")
ggplot(data = ddply(totalcrime, .(Towngroup, Year), summarise, 
      Total.crime.Rate = weighted.mean(Total.crime.Rate, 
                                       Total.estimated.population..Number)), 
       aes(x = Year, y = Total.crime.Rate)) + 
  geom_line(aes(group = Towngroup)) +
  geom_point(aes(shape = Towngroup)) +
  labs(x = NULL, y = "Crime rate by town (per 100K residents)") +
  scale_x_continuous(breaks = c(1998,2004,2010)) + 
  theme_minimal()
```
--- 
## Quality of life: voter turnout / registration

Source: [CT Secretary of State](http://www.ct.gov/sots/cwp/view.asp?a=3179&q=392194), [HartfordInfo](http://hartfordinfo.org/).

```{r echo = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 11}
voting <- read.csv('2012-voting.csv')
voting <- subset(voting, voting$Town %in% levels(towns$Town))
voting$Town <- factor(voting$Town)

voting$Town <- reorder(voting$Town, -voting$Percentage.Checked.as.Having.Voted)

vote1 <- ggplot(data = voting) + 
  geom_point(aes(x = Percentage.Checked.as.Having.Voted, y = Town)) + 
  labs(x = '% checked as having voted (11/6/2012 election)', y = NULL) + 
  scale_x_continuous(labels = percent) + 
  theme_minimal()

hartford_voting <- read.csv('hartford-voting.csv')

hartford_voting <- ddply(hartford_voting, .(Voting.District), summarise, 
                         turnout = mean(Ratio.to.city.average))

hartford_voting$Voting.District <- reorder(hartford_voting$Voting.District, -hartford_voting$turnout)

vote2 <- ggplot(data = hartford_voting) + 
  geom_point(aes(x = turnout, y = Voting.District)) + 
  labs(x = 'Voter turnout relative to city turnout (all elections, 2002 - 2012)', y = "Voting District") + 
  scale_x_continuous(labels = percent) + 
  theme_minimal()

grid.arrange(vote1,vote2,nrow=1)
```
